<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apify API Server Dashboard</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .api-endpoint {
            border-left: 4px solid var(--bs-primary);
            background: var(--bs-dark);
            margin-bottom: 1rem;
        }
        .method-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .method-get { background-color: #28a745; }
        .method-post { background-color: #007bff; }
        .method-put { background-color: #ffc107; }
        .method-delete { background-color: #dc3545; }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-unhealthy { background-color: #dc3545; }
        .status-unknown { background-color: #6c757d; }
        .log-container {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-line {
            padding: 4px 12px;
            border-bottom: 1px solid #333;
            white-space: pre-wrap;
        }
        .log-line:last-child {
            border-bottom: none;
        }
        .test-form {
            background-color: var(--bs-dark);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-robot me-2"></i>Apify API Server Dashboard</h1>
                    <div>
                        <span class="status-indicator" id="healthIndicator"></span>
                        <span id="healthStatus">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Check Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat me-2"></i>System Health</h5>
                    </div>
                    <div class="card-body">
                        <div id="healthInfo">Loading health information...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fab fa-youtube me-2"></i>YouTube Video Downloader</h5>
                    </div>
                    <div class="card-body">
                        <form id="youtubeDownloadForm">
                            <div class="mb-3">
                                <label for="youtubeUrl" class="form-label">YouTube URL</label>
                                <input type="url" class="form-control" id="youtubeUrl" 
                                       placeholder="https://www.youtube.com/watch?v=..." required>
                            </div>
                            <div class="mb-3">
                                <label for="quality" class="form-label">Quality</label>
                                <select class="form-select" id="quality">
                                    <option value="720">720p</option>
                                    <option value="1080">1080p</option>
                                    <option value="480">480p</option>
                                    <option value="360">360p</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-download me-2"></i>Start Download
                            </button>
                        </form>
                        <div id="downloadStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Recent Runs</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentRuns">Loading recent runs...</div>
                        <button class="btn btn-secondary btn-sm mt-2" onclick="loadRecentRuns()">
                            <i class="fas fa-refresh me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Endpoints -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-code me-2"></i>Available API Endpoints</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Actor Management -->
                            <div class="col-md-6">
                                <h6 class="mb-3"><i class="fas fa-play me-2"></i>Actor Management</h6>
                                
                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/health</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/health', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Check Apify API connectivity and configuration</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/actors</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/actors', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">List all available Apify actors</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/actors/{id}</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testActorInfo()">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Get detailed information about a specific actor</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-post">POST</span>
                                            <code>/api/apify/actors/{id}/start</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testActorStart()">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Start an Apify actor with input data</small>
                                </div>
                            </div>

                            <!-- Run Management -->
                            <div class="col-md-6">
                                <h6 class="mb-3"><i class="fas fa-tasks me-2"></i>Run Management</h6>
                                
                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/runs</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/runs', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">List actor runs with optional filtering</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/runs/{id}</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testRunStatus()">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Get comprehensive status of an actor run</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/runs/{id}/logs</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testRunLogs()">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Get real-time logs from an actor run</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-post">POST</span>
                                            <code>/api/apify/runs/{id}/abort</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testRunAbort()">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Abort a running actor</small>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <!-- Data Management -->
                            <div class="col-md-6">
                                <h6 class="mb-3"><i class="fas fa-database me-2"></i>Data Management</h6>
                                
                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/datasets</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/datasets', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">List all datasets</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/datasets/{id}/items</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testDatasetItems()">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Get items from a dataset</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/key-value-stores</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/key-value-stores', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">List all key-value stores</small>
                                </div>
                            </div>

                            <!-- Account & Monitoring -->
                            <div class="col-md-6">
                                <h6 class="mb-3"><i class="fas fa-user me-2"></i>Account & Monitoring</h6>
                                
                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/account</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/account', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Get account information and statistics</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/usage</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/usage', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Get usage statistics for the account</small>
                                </div>

                                <div class="api-endpoint card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge method-badge method-get">GET</span>
                                            <code>/api/apify/webhooks</code>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/apify/webhooks', 'GET')">Test</button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">List all webhooks</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal me-2"></i>API Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults" class="log-container" style="min-height: 200px;">
                            <div class="log-line text-muted">Click "Test" on any endpoint to see results here...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRunId = null;

        // Load initial health check
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            loadRecentRuns();
        });

        async function checkHealth() {
            try {
                const response = await fetch('/api/apify/health');
                const data = await response.json();
                
                const indicator = document.getElementById('healthIndicator');
                const status = document.getElementById('healthStatus');
                const healthInfo = document.getElementById('healthInfo');
                
                if (data.healthy) {
                    indicator.className = 'status-indicator status-healthy';
                    status.textContent = 'Healthy';
                    healthInfo.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Status:</strong> Connected<br>
                                <strong>Token:</strong> Configured<br>
                                <strong>Client:</strong> Initialized
                            </div>
                            <div class="col-md-6">
                                <strong>API Version:</strong> ${data.api_version || 'v2'}<br>
                                <strong>Base URL:</strong> ${data.base_url || 'https://api.apify.com/v2'}<br>
                                <strong>Last Check:</strong> ${new Date(data.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                } else {
                    indicator.className = 'status-indicator status-unhealthy';
                    status.textContent = 'Unhealthy';
                    healthInfo.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${data.error || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                const indicator = document.getElementById('healthIndicator');
                const status = document.getElementById('healthStatus');
                const healthInfo = document.getElementById('healthInfo');
                
                indicator.className = 'status-indicator status-unknown';
                status.textContent = 'Unknown';
                healthInfo.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Connection Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function loadRecentRuns() {
            try {
                const response = await fetch('/api/apify/runs?limit=5');
                const data = await response.json();
                
                const container = document.getElementById('recentRuns');
                
                if (data.success && data.runs.length > 0) {
                    container.innerHTML = data.runs.map(run => `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <small class="text-muted">${run.id.substring(0, 8)}...</small><br>
                                <span class="badge bg-${getStatusColor(run.status)}">${run.status}</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewRunDetails('${run.id}')">
                                View
                            </button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="text-muted">No recent runs found</div>';
                }
            } catch (error) {
                document.getElementById('recentRuns').innerHTML = 
                    `<div class="text-danger">Error loading runs: ${error.message}</div>`;
            }
        }

        function getStatusColor(status) {
            const colors = {
                'SUCCEEDED': 'success',
                'RUNNING': 'primary',
                'FAILED': 'danger',
                'READY': 'info',
                'ABORTED': 'warning'
            };
            return colors[status] || 'secondary';
        }

        // YouTube Download Form
        document.getElementById('youtubeDownloadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const url = document.getElementById('youtubeUrl').value;
            const quality = document.getElementById('quality').value;
            const statusDiv = document.getElementById('downloadStatus');
            
            statusDiv.innerHTML = '<div class="alert alert-info">Starting download...</div>';
            
            try {
                const response = await fetch('/api/apify/youtube-downloader/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        youtube_url: url,
                        quality: quality
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentRunId = data.run_id;
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Download Started!</strong><br>
                            Run ID: ${data.run_id}<br>
                            <button class="btn btn-sm btn-primary mt-2" onclick="monitorRun('${data.run_id}')">
                                Monitor Progress
                            </button>
                        </div>
                    `;
                    logToResults(`YouTube download started: ${data.run_id}`);
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        });

        async function testEndpoint(endpoint, method = 'GET', body = null) {
            logToResults(`Testing ${method} ${endpoint}...`);
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(endpoint, options);
                const data = await response.json();
                
                logToResults(`Response (${response.status}): ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                logToResults(`Error: ${error.message}`);
            }
        }

        async function testActorInfo() {
            const actorId = prompt('Enter Actor ID:', 'epctex/youtube-video-downloader');
            if (actorId) {
                await testEndpoint(`/api/apify/actors/${actorId}`, 'GET');
            }
        }

        async function testActorStart() {
            const actorId = prompt('Enter Actor ID:', 'epctex/youtube-video-downloader');
            if (actorId) {
                const input = {
                    startUrls: ['https://www.youtube.com/watch?v=dQw4w9WgXcQ'],
                    quality: '720',
                    proxy: { useApifyProxy: true }
                };
                await testEndpoint(`/api/apify/actors/${actorId}/start`, 'POST', { input });
            }
        }

        async function testRunStatus() {
            const runId = prompt('Enter Run ID:', currentRunId || '');
            if (runId) {
                await testEndpoint(`/api/apify/runs/${runId}`, 'GET');
            }
        }

        async function testRunLogs() {
            const runId = prompt('Enter Run ID:', currentRunId || '');
            if (runId) {
                await testEndpoint(`/api/apify/runs/${runId}/logs`, 'GET');
            }
        }

        async function testRunAbort() {
            const runId = prompt('Enter Run ID:', currentRunId || '');
            if (runId && confirm('Are you sure you want to abort this run?')) {
                await testEndpoint(`/api/apify/runs/${runId}/abort`, 'POST');
            }
        }

        async function testDatasetItems() {
            const datasetId = prompt('Enter Dataset ID:');
            if (datasetId) {
                await testEndpoint(`/api/apify/datasets/${datasetId}/items`, 'GET');
            }
        }

        async function viewRunDetails(runId) {
            currentRunId = runId;
            await testEndpoint(`/api/apify/runs/${runId}`, 'GET');
        }

        async function monitorRun(runId) {
            logToResults(`Monitoring run ${runId}...`);
            
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/apify/runs/${runId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const status = data.status;
                        const stats = data.stats;
                        
                        logToResults(`Run ${runId}: ${status} (${stats.duration_human}, ${stats.compute_units} CU)`);
                        
                        if (['SUCCEEDED', 'FAILED', 'ABORTED', 'TIMED-OUT'].includes(status)) {
                            clearInterval(interval);
                            logToResults(`Run ${runId} completed with status: ${status}`);
                            
                            if (status === 'SUCCEEDED' && data.default_dataset_id) {
                                // Get dataset results
                                const datasetResponse = await fetch(`/api/apify/datasets/${data.default_dataset_id}/items`);
                                const datasetData = await datasetResponse.json();
                                
                                if (datasetData.success && datasetData.items.length > 0) {
                                    const item = datasetData.items[0];
                                    logToResults(`Download URL: ${item.downloadUrl}`);
                                }
                            }
                        }
                    }
                } catch (error) {
                    logToResults(`Monitoring error: ${error.message}`);
                    clearInterval(interval);
                }
            }, 5000); // Check every 5 seconds
        }

        function logToResults(message) {
            const container = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = 'log-line';
            logLine.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logLine);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>